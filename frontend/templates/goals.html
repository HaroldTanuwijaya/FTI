{% extends "base.html" %} {% block content %}
<div class="min-h-screen bg-background-dark">
  <!-- Navbar -->
  <nav class="sticky top-0 z-30 bg-background-dark/80 backdrop-blur-md border-b border-border-dark px-6 py-4">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="bg-primary/20 p-1.5 rounded-lg">
          <span class="material-icons-round text-primary text-xl">savings</span>
        </div>
        <span class="text-white font-bold text-2xl tracking-tight">FTI</span>
        <span class="text-text-muted font-medium border-l border-border-dark pl-3 ml-1 text-xs uppercase tracking-widest hidden sm:inline-block">Financial Intelligence</span>
      </div>
      <div class="hidden md:flex items-center gap-8">
        <a class="text-text-muted hover:text-white transition-colors font-medium text-sm" href="/">Dashboard</a>
        <a class="text-text-muted hover:text-white transition-colors font-medium text-sm" href="/transactions">Transactions</a>
        <a class="text-text-muted hover:text-white transition-colors font-medium text-sm" href="/analytics">Analytics</a>
        <a class="text-primary font-medium text-sm border-b-2 border-primary pb-0.5" href="/goals">Goals</a>
      </div>
      <div class="flex items-center gap-2">
        <select id="currency-selector" class="hidden sm:block bg-surface-dark border border-border-dark text-text-muted text-xs px-3 py-1.5 rounded-lg hover:text-white transition-colors cursor-pointer">
          <option value="USD">$ USD</option>
          <option value="EUR">€ EUR</option>
          <option value="GBP">£ GBP</option>
          <option value="JPY">¥ JPY</option>
          <option value="IDR">Rp IDR</option>
        </select>
        <div class="relative hidden sm:block">
          <button id="notification-btn" class="relative text-text-muted hover:text-white transition-colors p-2 rounded-full hover:bg-white/5">
            <span class="material-icons-round text-xl">notifications</span>
            <span id="notification-badge" class="absolute top-2 right-2 h-2 w-2 bg-danger rounded-full ring-2 ring-background-dark hidden"></span>
          </button>
          <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-96 bg-surface-dark border border-border-dark rounded-xl shadow-card z-50 max-h-96 overflow-hidden">
            <div class="p-4 border-b border-border-dark flex items-center justify-between">
              <h3 class="font-semibold text-white">Notifications</h3>
              <button id="mark-all-read" class="text-xs text-primary hover:text-white">Mark all read</button>
            </div>
            <div id="notification-list" class="overflow-y-auto max-h-80">
              <div class="p-8 text-center text-text-muted">
                <span class="material-icons-round text-4xl mb-2 opacity-50">notifications_none</span>
                <p>No notifications</p>
              </div>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-3 pl-4 border-l border-border-dark">
          <div class="text-right hidden sm:block">
            <p class="text-xs font-semibold text-white" id="user-name">User</p>
            <p class="text-[10px] text-text-muted uppercase">Member</p>
          </div>
          <button id="logout-btn" class="h-9 w-9 rounded-full bg-gradient-to-tr from-primary to-blue-600 flex items-center justify-center text-white font-bold text-xs shadow-glow ring-2 ring-background-dark hover:ring-primary transition-all" title="Logout">
            <span class="material-icons-round text-sm">logout</span>
          </button>
        </div>
        <button id="mobile-menu-btn" class="md:hidden text-text-muted hover:text-white transition-colors p-2">
          <span class="material-icons-round text-xl">menu</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- Mobile Menu -->
  <div id="mobile-menu" class="hidden md:hidden bg-surface-dark border-b border-border-dark">
    <div class="px-4 py-3 space-y-3">
      <a href="/" class="flex items-center gap-3 text-text-muted hover:text-white transition-colors py-2">
        <span class="material-icons-round text-sm">dashboard</span>
        <span>Dashboard</span>
      </a>
      <a href="/transactions" class="flex items-center gap-3 text-text-muted hover:text-white transition-colors py-2">
        <span class="material-icons-round text-sm">receipt_long</span>
        <span>Transactions</span>
      </a>
      <a href="/analytics" class="flex items-center gap-3 text-text-muted hover:text-white transition-colors py-2">
        <span class="material-icons-round text-sm">analytics</span>
        <span>Analytics</span>
      </a>
      <a href="/goals" class="flex items-center gap-3 text-primary font-medium py-2">
        <span class="material-icons-round text-sm">flag</span>
        <span>Goals</span>
      </a>
      <div class="pt-2 border-t border-border-dark">
        <label class="block text-xs text-text-muted mb-2">Currency</label>
        <select id="currency-selector-mobile" class="w-full bg-background-dark border border-border-dark text-white text-sm px-3 py-2 rounded-lg">
          <option value="USD">$ USD</option>
          <option value="EUR">€ EUR</option>
          <option value="GBP">£ GBP</option>
          <option value="JPY">¥ JPY</option>
          <option value="IDR">Rp IDR</option>
        </select>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-white mb-2">Financial Goals</h1>
          <p class="text-text-muted">Track your progress towards financial milestones</p>
        </div>
        <button
          id="add-goal-btn"
          class="flex items-center gap-2 bg-primary hover:bg-sky-500 text-white px-6 py-3 rounded-lg text-sm font-medium transition-all shadow-glow"
        >
          <span class="material-icons-round text-base">add</span>
          <span>New Goal</span>
        </button>
      </div>
    </div>

    <!-- Goals Grid -->
    <div id="goals-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Goals will be loaded here -->
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-16">
      <div class="bg-surface-dark rounded-2xl p-12 border border-border-dark">
        <span class="material-icons-round text-6xl text-text-muted opacity-50 mb-4">flag</span>
        <h3 class="text-xl font-semibold text-white mb-2">No Goals Yet</h3>
        <p class="text-text-muted mb-6">Start by creating your first financial goal</p>
        <button
          class="bg-primary hover:bg-sky-500 text-white px-6 py-3 rounded-lg text-sm font-medium transition-all"
          onclick="$('#add-goal-btn').click()"
        >
          Create Your First Goal
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center">
  <div class="bg-surface-dark rounded-2xl p-8 border border-border-dark shadow-card">
    <div class="flex flex-col items-center gap-4">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
      <p class="text-white font-medium">Loading...</p>
    </div>
  </div>
</div>

<!-- Add/Edit Goal Modal -->
<div id="goal-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
  <div class="bg-surface-dark rounded-2xl shadow-card border border-border-dark max-w-md w-full">
    <div class="p-6 border-b border-border-dark flex items-center justify-between">
      <h3 class="text-xl font-semibold text-white">Add Financial Goal</h3>
      <button id="close-goal-modal" class="text-text-muted hover:text-white transition-colors">
        <span class="material-icons-round">close</span>
      </button>
    </div>

    <form id="goal-form" class="p-6 space-y-4">
      <input type="hidden" id="goal-id" value="">

      <div>
        <label class="block text-sm font-medium text-text-muted mb-2">Goal Name</label>
        <input
          type="text"
          id="goal-name"
          required
          minlength="3"
          maxlength="100"
          placeholder="e.g., Emergency Fund"
          class="w-full px-4 py-3 bg-background-dark border border-border-dark rounded-lg text-white placeholder-text-muted focus:border-primary focus:ring-1 focus:ring-primary transition-colors"
        />
        <p class="text-xs text-text-muted mt-1">Minimum 3 characters</p>
      </div>

      <div>
        <label class="block text-sm font-medium text-text-muted mb-2">Target Amount</label>
        <input
          type="number"
          id="goal-amount"
          step="0.01"
          min="1"
          max="1000000000"
          required
          placeholder="0.00"
          class="w-full px-4 py-3 bg-background-dark border border-border-dark rounded-lg text-white placeholder-text-muted focus:border-primary focus:ring-1 focus:ring-primary transition-colors"
        />
        <p class="text-xs text-text-muted mt-1">Must be greater than 0</p>
      </div>

      <div>
        <label class="block text-sm font-medium text-text-muted mb-2">Current Amount</label>
        <input
          type="number"
          id="goal-current"
          step="0.01"
          min="0"
          max="1000000000"
          value="0"
          placeholder="0.00"
          class="w-full px-4 py-3 bg-background-dark border border-border-dark rounded-lg text-white placeholder-text-muted focus:border-primary focus:ring-1 focus:ring-primary transition-colors"
        />
      </div>

      <div>
        <label class="block text-sm font-medium text-text-muted mb-2">Target Date</label>
        <input
          type="date"
          id="goal-deadline"
          required
          class="w-full px-4 py-3 bg-background-dark border border-border-dark rounded-lg text-white focus:border-primary focus:ring-1 focus:ring-primary transition-colors"
        />
        <p class="text-xs text-text-muted mt-1">Must be a future date</p>
      </div>

      <div class="flex gap-3 pt-4">
        <button
          type="button"
          id="cancel-goal-btn"
          class="flex-1 px-4 py-3 bg-surface-dark-hover border border-border-dark text-text-muted rounded-lg hover:text-white transition-colors"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="flex-1 px-4 py-3 bg-primary hover:bg-sky-500 text-white rounded-lg font-medium transition-all shadow-glow"
        >
          Save Goal
        </button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Global variables
  let currentCurrency = 'USD';
  let currencySymbols = {
      'USD': '$',
      'EUR': '€',
      'GBP': '£',
      'JPY': '¥',
      'IDR': 'Rp'
  };
  
  // Loading & Error Handling
  function showLoading() {
    $('#loading-overlay').removeClass('hidden');
  }
  
  function hideLoading() {
    $('#loading-overlay').addClass('hidden');
  }
  
  function showError(title, message) {
    hideLoading();
    Swal.fire({
      icon: 'error',
      title: title || 'Error',
      text: message || 'Something went wrong. Please try again.',
      confirmButtonColor: '#38bdf8'
    });
  }
  
  function showSuccess(title, message) {
    Swal.fire({
      icon: 'success',
      title: title,
      text: message,
      timer: 2000,
      showConfirmButton: false
    });
  }

  $(document).ready(function () {
    // Check authentication
    const token = localStorage.getItem("fti_token");
    if (!token) {
      window.location.href = "/login";
      return;
    }

    // Setup AJAX defaults
    $.ajaxSetup({
      beforeSend: function (xhr) {
        xhr.setRequestHeader("Authorization", "Bearer " + token);
      },
      error: function (xhr) {
        if (xhr.status === 401) {
          localStorage.removeItem("fti_token");
          window.location.href = "/login";
        }
      },
    });

    // Load data
    loadGoals();
    loadCurrency();
    loadNotifications();

    // Event handlers
    $("#add-goal-btn").click(() => showGoalModal());
    $("#close-goal-modal, #cancel-goal-btn").click(() => hideGoalModal());
    $("#goal-form").submit(saveGoal);
    $("#logout-btn").click(() => logout());
    $("#notification-btn").click(() => toggleNotifications());
    $("#mark-all-read").click(() => markAllRead());
    $('#currency-selector').change(function() {
      saveCurrency($(this).val());
    });
    
    // Mobile menu toggle
    $('#mobile-menu-btn').click(function() {
      $('#mobile-menu').toggleClass('hidden');
    });
    
    // Sync mobile currency selector
    $('#currency-selector-mobile').change(function() {
      const currency = $(this).val();
      $('#currency-selector').val(currency);
      saveCurrency(currency);
    });
    
    // Close dropdowns
    $(document).click(function(e) {
      if (!$(e.target).closest("#notification-btn, #notification-dropdown").length) {
        $("#notification-dropdown").addClass("hidden");
      }
      if (!$(e.target).closest('#mobile-menu-btn, #mobile-menu').length) {
        $('#mobile-menu').addClass('hidden');
      }
    });
  });

  function loadCurrency() {
    $.ajax({
      url: '/api/settings/currency',
      method: 'GET',
      success: function(data) {
        currentCurrency = data.currency || 'USD';
        $('#currency-selector').val(currentCurrency);
        $('#currency-selector-mobile').val(currentCurrency);
      }
    });
  }
  function saveCurrency(currency) {
    $.ajax({
      url: '/api/settings/currency',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ currency: currency }),
      success: function() {
        currentCurrency = currency;
        loadGoals();
        Swal.fire({
          icon: 'success',
          title: 'Currency Updated',
          timer: 1500,
          showConfirmButton: false
        });
      }
    });
  }
  
  function loadNotifications() {
    $.ajax({
      url: '/api/alerts',
      method: 'GET',
      success: function(data) {
        const unreadCount = (data.alerts || []).filter(a => !a.read).length;
        if (unreadCount > 0) {
          $('#notification-badge').removeClass('hidden');
        }
      }
    });
  }
  
  function toggleNotifications() {
    $('#notification-dropdown').toggleClass('hidden');
  }
  
  function markAllRead() {
    $.ajax({
      url: '/api/alerts/mark-read',
      method: 'POST',
      success: function() {
        $('#notification-badge').addClass('hidden');
      }
    });
  }
  
  function logout() {
    Swal.fire({
      title: "Logout?",
      text: "Are you sure you want to logout?",
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "Yes, logout",
      confirmButtonColor: "#f87171",
    }).then((result) => {
      if (result.isConfirmed) {
        localStorage.removeItem("fti_token");
        window.location.href = "/login";
      }
    });
  }

  function loadGoals() {
    showLoading();
    
    $.ajax({
      url: "/api/goals",
      method: "GET",
      success: function (data) {
        hideLoading();
        renderGoals(data.goals || []);
      },
      error: function (xhr) {
        const errorMsg = xhr.responseJSON?.error || "Failed to load goals";
        showError("Load Error", errorMsg);
      },
    });
  }

  function renderGoals(goals) {
    const container = $("#goals-container");
    const symbol = currencySymbols[currentCurrency] || '$';

    if (goals.length === 0) {
      container.html("");
      $("#empty-state").removeClass("hidden");
      return;
    }

    $("#empty-state").addClass("hidden");
    let html = "";

    goals.forEach((goal) => {
      const progress = Math.min((goal.current_amount / goal.target_amount) * 100, 100);
      const remaining = goal.target_amount - goal.current_amount;
      const daysLeft = Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24));
      
      let statusColor = 'primary';
      let statusText = 'In Progress';
      if (progress >= 100) {
        statusColor = 'success';
        statusText = 'Completed';
      } else if (daysLeft < 0) {
        statusColor = 'danger';
        statusText = 'Overdue';
      }

      html += `
        <div class="bg-surface-dark rounded-2xl shadow-card border border-border-dark p-6 hover:border-primary/50 transition-all group">
          <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="p-3 bg-primary/10 rounded-xl text-primary">
                <span class="material-icons-round">flag</span>
              </div>
              <div>
                <h3 class="font-semibold text-white text-lg">${goal.name}</h3>
                <span class="text-xs px-2 py-1 rounded bg-${statusColor}/10 text-${statusColor}">${statusText}</span>
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="editGoal('${goal._id}')" class="text-text-muted hover:text-primary transition-colors">
                <span class="material-icons-round text-sm">edit</span>
              </button>
              <button onclick="deleteGoal('${goal._id}')" class="text-text-muted hover:text-danger transition-colors">
                <span class="material-icons-round text-sm">delete</span>
              </button>
            </div>
          </div>

          <div class="space-y-4">
            <div>
              <div class="flex justify-between text-sm mb-2">
                <span class="text-text-muted">Progress</span>
                <span class="font-semibold text-white">${progress.toFixed(0)}%</span>
              </div>
              <div class="w-full bg-slate-800 h-3 rounded-full overflow-hidden">
                <div class="bg-gradient-to-r from-primary to-sky-400 h-full rounded-full transition-all duration-500" style="width: ${progress}%"></div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4 pt-2">
              <div>
                <p class="text-xs text-text-muted mb-1">Current</p>
                <p class="text-lg font-bold text-white">${symbol}${goal.current_amount.toLocaleString()}</p>
              </div>
              <div>
                <p class="text-xs text-text-muted mb-1">Target</p>
                <p class="text-lg font-bold text-primary">${symbol}${goal.target_amount.toLocaleString()}</p>
              </div>
            </div>

            <div class="pt-2 border-t border-border-dark">
              <div class="flex items-center justify-between text-sm">
                <span class="text-text-muted">Remaining</span>
                <span class="font-semibold text-white">${symbol}${Math.max(0, remaining).toLocaleString()}</span>
              </div>
              <div class="flex items-center justify-between text-sm mt-2">
                <span class="text-text-muted">Deadline</span>
                <span class="font-semibold ${daysLeft < 0 ? 'text-danger' : 'text-white'}">${new Date(goal.deadline).toLocaleDateString()}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    });

    container.html(html);
  }

  function showGoalModal(goalData = null) {
    if (goalData) {
      $("#goal-id").val(goalData._id);
      $("#goal-name").val(goalData.name);
      $("#goal-amount").val(goalData.target_amount);
      $("#goal-current").val(goalData.current_amount);
      $("#goal-deadline").val(goalData.deadline.split("T")[0]);
      $("h3").text("Edit Financial Goal");
    } else {
      $("#goal-form")[0].reset();
      $("#goal-id").val("");
      $("h3").text("Add Financial Goal");
    }
    $("#goal-modal").removeClass("hidden");
  }

  function hideGoalModal() {
    $("#goal-modal").addClass("hidden");
  }

  function saveGoal(e) {
    e.preventDefault();

    const goalId = $("#goal-id").val();
    const name = $("#goal-name").val().trim();
    const targetAmount = parseFloat($("#goal-amount").val());
    const currentAmount = parseFloat($("#goal-current").val()) || 0;
    const deadline = $("#goal-deadline").val();
    
    // Validation
    if (!name || name.length < 3) {
      showError("Validation Error", "Goal name must be at least 3 characters");
      return;
    }
    if (name.length > 100) {
      showError("Validation Error", "Goal name is too long (max 100 characters)");
      return;
    }
    if (!targetAmount || isNaN(targetAmount) || targetAmount <= 0) {
      showError("Validation Error", "Target amount must be greater than 0");
      return;
    }
    if (targetAmount > 1000000000) {
      showError("Validation Error", "Target amount is too large");
      return;
    }
    if (isNaN(currentAmount) || currentAmount < 0) {
      showError("Validation Error", "Current amount must be 0 or greater");
      return;
    }
    if (currentAmount > targetAmount) {
      showError("Validation Error", "Current amount cannot exceed target amount");
      return;
    }
    if (!deadline) {
      showError("Validation Error", "Target date is required");
      return;
    }
    
    const deadlineDate = new Date(deadline);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (deadlineDate < today) {
      showError("Validation Error", "Target date must be in the future");
      return;
    }

    const goalData = {
      name: name,
      target_amount: targetAmount,
      current_amount: currentAmount,
      deadline: deadline,
    };

    const url = goalId ? `/api/goals/${goalId}` : "/api/goals";
    const method = goalId ? "PUT" : "POST";

    showLoading();

    $.ajax({
      url: url,
      method: method,
      contentType: "application/json",
      data: JSON.stringify(goalData),
      success: function () {
        hideGoalModal();
        loadGoals();
        showSuccess(goalId ? "Goal Updated" : "Goal Created", "Your goal has been saved successfully");
      },
      error: function (xhr) {
        const errorMsg = xhr.responseJSON?.error || "Failed to save goal";
        showError("Save Error", errorMsg);
      },
    });
  }

  function editGoal(goalId) {
    $.ajax({
      url: `/api/goals/${goalId}`,
      method: "GET",
      success: function (data) {
        showGoalModal(data);
      },
      error: function () {
        Swal.fire("Error", "Failed to load goal", "error");
      },
    });
  }

  function deleteGoal(goalId) {
    Swal.fire({
      title: "Delete Goal?",
      text: "This action cannot be undone",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#f87171",
      confirmButtonText: "Yes, delete it",
    }).then((result) => {
      if (result.isConfirmed) {
        showLoading();
        
        $.ajax({
          url: `/api/goals/${goalId}`,
          method: "DELETE",
          success: function () {
            loadGoals();
            showSuccess("Goal Deleted", "Your goal has been removed");
          },
          error: function (xhr) {
            const errorMsg = xhr.responseJSON?.error || "Failed to delete goal";
            showError("Delete Error", errorMsg);
          },
        });
      }
    });
  }
</script>
{% endblock %}
